package org.opentestsystem.ap.itemcompare;

import com.google.common.collect.ImmutableList;
import org.jsoup.Jsoup;
import org.opentestsystem.ap.common.saaif.item.ItemRelease;
import org.opentestsystem.ap.itemcompare.comparer.html.HtmlComparisonContext;
import org.opentestsystem.ap.itemcompare.comparer.html.comparison.HtmlComparison;
import org.opentestsystem.ap.itemcompare.model.CompareContext;
import org.opentestsystem.ap.itemcompare.model.ItemComparison;
import org.opentestsystem.ap.itemcompare.model.ItemDifference;
import org.opentestsystem.ap.itemcompare.model.ItemReference;

import java.nio.file.Paths;
import java.util.Collections;
import java.util.UUID;

import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;
import static org.opentestsystem.ap.common.model.ModelConstants.ItemType.TYPE_EQ;

/**
 * Test support class for generating mock models.
 */
public class CompareModelSupport {

    public static CompareContext compareContext(final String itemId) {
        return compareContext(itemId, TYPE_EQ);
    }

    public static CompareContext compareContext(final String itemId, final String itemType) {
        final CompareContext compareContext = new CompareContext(itemId);
        compareContext.setItemComparison(itemComparison(itemId, itemType));
        return compareContext;
    }

    public static ItemComparison itemComparison(final String itemId) {
        return itemComparison(itemId, TYPE_EQ);
    }

    public static ItemComparison itemComparison(final String itemId, final String itemType) {
        return ItemComparison.builder()
            .itemId(itemId)
            .test(itemReference(itemType))
            .source(itemReference(itemType))
            .build();
    }

    public static ItemReference itemReference(final String itemType) {
        return ItemReference.builder()
            .itemRelease(releaseWithResources(itemType))
            .itemXml(Paths.get("/mock/my-item.xml"))
            .build();
    }

    public static ItemRelease releaseWithResources() {
        return releaseWithResources(TYPE_EQ);
    }

    public static ItemRelease releaseWithResources(final String itemType) {
        final ItemRelease.Item.MachineRubric rubric = mock(ItemRelease.Item.MachineRubric.class);
        when(rubric.getFilename()).thenReturn("Item_183704_v11.qrx");

        final ItemRelease.Item.RendererSpec rendererSpec = mock(ItemRelease.Item.RendererSpec.class);
        when(rendererSpec.getFilename()).thenReturn("Item_183704_v11.eax");

        final ItemRelease.Item.Content englishContent = mock(ItemRelease.Item.Content.class, "English Content");
        when(englishContent.getLanguage()).thenReturn("ENU");
        when(englishContent.getStem()).thenReturn("<p>English Stem</p>");

        final ItemRelease.Item.Content spanishContent = mock(ItemRelease.Item.Content.class, "Spanish Content");
        when(spanishContent.getLanguage()).thenReturn("ESN");
        when(spanishContent.getStem()).thenReturn("<p>Spanish Stem</p>");

        final ItemRelease.Item item = mock(ItemRelease.Item.class);
        when(item.getFormat()).thenReturn(itemType);
        when(item.getMachineRubric()).thenReturn(Collections.singletonList(rubric));
        when(item.getRendererSpec()).thenReturn(Collections.singletonList(rendererSpec));
        when(item.getContent()).thenReturn(ImmutableList.of(englishContent, spanishContent));

        final ItemRelease itemRelease = mock(ItemRelease.class);
        when(itemRelease.getItem()).thenReturn(item);
        return itemRelease;
    }

    public static ItemDifference itemDifference(final String differenceType) {
        return ItemDifference.builder()
            .differenceType(differenceType)
            .location(UUID.randomUUID().toString())
            .testValue(UUID.randomUUID().toString())
            .sourceValue(UUID.randomUUID().toString())
            .filename("filename")
            .build();
    }

    public static HtmlComparisonContext htmlComparisonContext(final String sourceHtml, final String testHtml) {
        final HtmlComparison comparison = HtmlComparison.builder()
            .location("Somewhere")
            .sourceHtml(sourceHtml)
            .testHtml(testHtml)
            .build();
        return HtmlComparisonContext.builder()
            .comparison(comparison)
            .filename("filename.xml")
            .sourceDocument(sourceHtml == null ? null : Jsoup.parseBodyFragment(sourceHtml))
            .testDocument(testHtml == null ? null : Jsoup.parseBodyFragment(testHtml))
            .build();
    }

    public static ItemComparison passageComparison(final String itemId) {
        return ItemComparison.builder()
            .itemId(itemId)
            .test(passageReference())
            .source(passageReference())
            .build();
    }

    private static ItemReference passageReference() {
        return ItemReference.builder()
            .itemRelease(passageReleaseWithResources())
            .itemXml(Paths.get("/mock/my-stim.xml"))
            .build();
    }

    private static ItemRelease passageReleaseWithResources() {
        final ItemRelease.Passage.Content englishContent = mock(ItemRelease.Passage.Content.class, "English Content");
        when(englishContent.getLanguage()).thenReturn("ENU");
        when(englishContent.getStem()).thenReturn("<p>English Stem</p>");

        final ItemRelease.Passage.Content spanishContent = mock(ItemRelease.Passage.Content.class, "Spanish Content");
        when(spanishContent.getLanguage()).thenReturn("ESN");
        when(spanishContent.getStem()).thenReturn("<p>Spanish Stem</p>");

        final ItemRelease.Passage item = mock(ItemRelease.Passage.class);
        when(item.getFormat()).thenReturn("stim");
        when(item.getContent()).thenReturn(ImmutableList.of(englishContent, spanishContent));

        final ItemRelease itemRelease = mock(ItemRelease.class);
        when(itemRelease.getPassage()).thenReturn(item);
        return itemRelease;
    }
}
