package org.opentestsystem.ap.itemcompare.comparer.html.comparison;

import com.google.common.base.Functions;
import com.google.common.collect.ImmutableMap;
import com.google.common.collect.Sets;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.tuple.Triple;
import org.eclipse.jgit.util.StringUtils;
import org.opentestsystem.ap.common.model.ModelConstants;
import org.opentestsystem.ap.common.saaif.item.ItemRelease;
import org.opentestsystem.ap.itemcompare.model.ItemComparison;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.stream.Collectors;

import static org.apache.commons.lang3.StringUtils.isBlank;
import static org.apache.commons.lang3.StringUtils.isNotBlank;

/**
 * Default item-type-aware html comparison provider.
 */
@Component
@Slf4j
class DefaultHtmlComparisonProvider implements HtmlComparisonProvider {
    private static final Map<String, String> LanguageDisplayMap = ImmutableMap.of(
        "enu", "English",
        "esn", "Spanish"
    );

    private final Set<ItemTypeHtmlComparisonProvider> itemTypeProviders;

    @Autowired
    public DefaultHtmlComparisonProvider(final Set<ItemTypeHtmlComparisonProvider> itemTypeProviders) {
        this.itemTypeProviders = itemTypeProviders;
    }

    @Override
    public List<HtmlComparison> getComparisons(final ItemComparison itemComparison) {
        final ItemTypeHtmlComparisonContext context = new ItemTypeHtmlComparisonContext();

        final ItemRelease sourceRelease = itemComparison.getSource().getItemRelease();
        final ItemRelease testRelease = itemComparison.getTest().getItemRelease();

        context.setItemType(getFormat(sourceRelease, testRelease));
        updateItemComparisons(context, sourceRelease.getItem(), testRelease.getItem());
        updatePassageComparisons(context, sourceRelease.getPassage(), testRelease.getPassage());

        return context.getComparisons();
    }

    private void updateItemComparisons(ItemTypeHtmlComparisonContext context, ItemRelease.Item sourceItem, ItemRelease.Item testItem) {
        if (sourceItem == null && testItem == null) return;

        getContentByLanguage(sourceItem, testItem).forEach(triple -> {
            context.setLanguage(triple.getLeft());
            itemTypeProviders.forEach(provider -> provider.appendComparisons(context, triple.getMiddle(), triple.getRight()));
        });
    }

    private void updatePassageComparisons(ItemTypeHtmlComparisonContext context, ItemRelease.Passage sourcePassage, ItemRelease.Passage testPassage) {
        if (sourcePassage == null && testPassage == null) return;

        getContentByLanguage(sourcePassage, testPassage).forEach(triple -> {
            context.setLanguage(triple.getLeft());
            itemTypeProviders.forEach(provider -> provider.appendComparisons(context, triple.getMiddle(), triple.getRight()));
        });
    }

    private String getFormat(final ItemRelease sourceRelease, final ItemRelease testRelease) {
        String format = getFormatFromRelease(testRelease);
        if(isBlank(format)) {
            format = getFormatFromRelease(sourceRelease);
        }

        return isNotBlank(format) ? format : "UNKNOWN";
    }

    private List<Triple<String, ItemRelease.Item.Content, ItemRelease.Item.Content>> getContentByLanguage(final ItemRelease.Item sourceItem, final ItemRelease.Item testItem) {
        final Map<String, ItemRelease.Item.Content> sourceContentByLanguage = getItemContentByLanguage(sourceItem);
        final Map<String, ItemRelease.Item.Content> testContentByLanguage = getItemContentByLanguage(testItem);

        return Sets.union(sourceContentByLanguage.keySet(), testContentByLanguage.keySet()).stream()
            .map(language -> Triple.of(language, sourceContentByLanguage.get(language), testContentByLanguage.get(language)))
            .collect(Collectors.toList());
    }

    private List<Triple<String, ItemRelease.Passage.Content, ItemRelease.Passage.Content>> getContentByLanguage(final ItemRelease.Passage sourcePassage, final ItemRelease.Passage testPassage) {
        final Map<String, ItemRelease.Passage.Content> sourceContentByLanguage = getPassageContentByLanguage(sourcePassage);
        final Map<String, ItemRelease.Passage.Content> testContentByLanguage = getPassageContentByLanguage(testPassage);

        return Sets.union(sourceContentByLanguage.keySet(), testContentByLanguage.keySet()).stream()
            .map(language -> Triple.of(language, sourceContentByLanguage.get(language), testContentByLanguage.get(language)))
            .collect(Collectors.toList());
    }

    private Map<String, ItemRelease.Item.Content> getItemContentByLanguage(final ItemRelease.Item item) {
        if (item == null || item.getContent() == null) return Collections.emptyMap();

        return item.getContent().stream()
            .collect(Collectors.toMap(
                this::getLanguage,
                Functions.identity()
            ));
    }

    private Map<String, ItemRelease.Passage.Content> getPassageContentByLanguage(final ItemRelease.Passage passage) {
        if (passage == null || passage.getContent() == null) return Collections.emptyMap();

        return passage.getContent().stream()
            .collect(Collectors.toMap(
                this::getLanguage,
                Functions.identity()
            ));
    }

    private String getLanguage(final ItemRelease.Item.Content content) {
        return LanguageDisplayMap.getOrDefault(StringUtils.toLowerCase(content.getLanguage()), content.getLanguage());
    }

    private String getLanguage(final ItemRelease.Passage.Content content) {
        return LanguageDisplayMap.getOrDefault(StringUtils.toLowerCase(content.getLanguage()), content.getLanguage());
    }

    private String getFormatFromRelease(final ItemRelease itemRelease) {
        if(itemRelease == null) return "";

        if(itemRelease.getItem() == null && itemRelease.getPassage() == null) {
            return "";
        } else if(itemRelease.getPassage() != null) {
            //Passages are always stims and do not need special processing.
            return itemRelease.getPassage().getFormat();
        }

        String format = itemRelease.getItem().getFormat();

        if(format.startsWith("ht")) {
            String htqItemType = getIatHtqType(itemRelease);
            format = !StringUtils.isEmptyOrNull(htqItemType) ? htqItemType : format;
        } else if("ER".equalsIgnoreCase(format)) {
            format = ModelConstants.ItemType.TYPE_SA;
        }

        return format;
    }

    private String getIatHtqType(ItemRelease release) {
        String iatHtqType = "";
        for (ItemRelease.Item.Content content : release.getItem().getContent()) {
            if (content.getLanguage().equals(ModelConstants.ItemLanguage.LANG_ENU)) {
                if (content.getStem().contains("interaction selectable")) {
                    iatHtqType = ModelConstants.ItemType.TYPE_HTQS;
                    break;
                } else {
                    iatHtqType = ModelConstants.ItemType.TYPE_HTQO;
                    break;
                }
            }
        }
        return iatHtqType;
    }
}
