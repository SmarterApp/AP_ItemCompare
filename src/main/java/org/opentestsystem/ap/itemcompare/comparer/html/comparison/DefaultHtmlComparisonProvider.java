package org.opentestsystem.ap.itemcompare.comparer.html.comparison;

import com.google.common.base.Functions;
import com.google.common.collect.ImmutableMap;
import com.google.common.collect.Sets;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.tuple.Triple;
import org.eclipse.jgit.util.StringUtils;
import org.opentestsystem.ap.common.saaif.item.ItemRelease;
import org.opentestsystem.ap.itemcompare.model.ItemComparison;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.stream.Collectors;

import static org.apache.commons.lang3.StringUtils.isBlank;
import static org.apache.commons.lang3.StringUtils.isNotBlank;

/**
 * Default item-type-aware html comparison provider.
 */
@Component
@Slf4j
class DefaultHtmlComparisonProvider implements HtmlComparisonProvider {
    private static final Map<String, String> LanguageDisplayMap = ImmutableMap.of(
        "enu", "English",
        "esn", "Spanish"
    );

    private final Set<ItemTypeHtmlComparisonProvider> itemTypeProviders;

    @Autowired
    public DefaultHtmlComparisonProvider(final Set<ItemTypeHtmlComparisonProvider> itemTypeProviders) {
        this.itemTypeProviders = itemTypeProviders;
    }

    @Override
    public List<HtmlComparison> getComparisons(final ItemComparison itemComparison) {
        final ItemRelease sourceRelease = itemComparison.getSource().getItemRelease();
        final ItemRelease testRelease = itemComparison.getTest().getItemRelease();
        final ItemTypeHtmlComparisonContext context = new ItemTypeHtmlComparisonContext();

        itemTypeProviders.forEach(provider -> provider.appendComparisons(context, sourceRelease, testRelease));

        final ItemRelease.Item sourceItem = sourceRelease.getItem();
        final ItemRelease.Item testItem = testRelease.getItem();
        if (sourceItem == null && testItem == null) return context.getComparisons();

        context.setItemType(getFormat(sourceItem, testItem));
        itemTypeProviders.forEach(provider -> provider.appendComparisons(context, sourceItem, testItem));

        getContentByLanguage(sourceItem, testItem).forEach(triple -> {
            context.setLanguage(triple.getLeft());
            itemTypeProviders.forEach(provider -> provider.appendComparisons(context, triple.getMiddle(), triple.getRight()));
        });

        return context.getComparisons();
    }

    private String getFormat(final ItemRelease.Item sourceItem, final ItemRelease.Item testItem) {
        if (testItem != null && isNotBlank(testItem.getFormat())) return testItem.getFormat();
        if (sourceItem != null && isNotBlank(sourceItem.getFormat())) return sourceItem.getFormat();
        return "UNKNOWN";
    }

    private List<Triple<String, ItemRelease.Item.Content, ItemRelease.Item.Content>> getContentByLanguage(final ItemRelease.Item sourceItem, final ItemRelease.Item testItem) {
        final Map<String, ItemRelease.Item.Content> sourceContentByLanguage = getItemContentByLanguage(sourceItem);
        final Map<String, ItemRelease.Item.Content> testContentByLanguage = getItemContentByLanguage(testItem);

        return Sets.union(sourceContentByLanguage.keySet(), testContentByLanguage.keySet()).stream()
            .map(language -> Triple.of(language, sourceContentByLanguage.get(language), testContentByLanguage.get(language)))
            .collect(Collectors.toList());
    }

    private Map<String, ItemRelease.Item.Content> getItemContentByLanguage(final ItemRelease.Item item) {
        if (item == null || item.getContent() == null) return Collections.emptyMap();

        return item.getContent().stream()
            .collect(Collectors.toMap(
                this::getLanguage,
                Functions.identity()
            ));
    }

    private String getLanguage(final ItemRelease.Item.Content content) {
        final String language = content.getLanguage();
        if (isBlank(language)) {
            log.warn("ItemRelease.Item.Content without language found. Defaulting to English.");
            return LanguageDisplayMap.get("enu");
        }
        return LanguageDisplayMap.getOrDefault(StringUtils.toLowerCase(language), language);
    }
}
